
<%= render plain: params[:video].inspect %>
<h2 class='show_title'><%= @video.name %></h2>
<%= video_tag @video.path, size: "854x480", controls: true, poster: @path, id: 'video', class: 'video-player' %>
<div id="show_video_description"><%= @video.description %></div>

<%# Only supervisors and the executive can add custom thumbnails %>
<% if current_user.user_level_id == SUPERVISOR_VALUE || current_user.user_level_id == EXECUTIVE_VALUE %>
<h2>Pick an existing image for thumbnail</h2>
<%= form_for @video do |f| %>
  <div class="form_group">
    <%= collection_select :video, :image_id, Image.order(:id), :id, :name, prompt: true %>
  </div>
  <div class="form_group">
    <%= f.submit 'Update thumbnail' %>
  </div>
<% end %>
<h2>OR</h2>
<h2>Create custom thumbnail</h2>

<button id="capture">Capture</button>

<canvas id="canvas" class='hidden'></canvas>
<img id='video_image' style="width:426px; height:240px; border:2px solid black;" src="" />
<% end %>
<%= form_for Image.new, html: {class: '', id: 'upload_form'} do |f| %>
  <%#= hidden_field(:image, :video_path, value: @video.base64) %>
  <div class="form_group">
    <%= f.label :name %>
    <%= f.text_field :name %>
    <%= f.text_field :video_path, id: 'video_path_field', class: 'hidden' %>
  </div>
  <div class='form_group'>
    <%= f.submit 'Create thumbnail' %>
  </div>
<% end %>
<script>
  



	var blobReader = new FileReader();

  function thumbnail(){
    var canvas = document.getElementById('canvas');
    var video = document.getElementById('video');
    canvas.height = 240;
    canvas.width = 426;
    canvas.getContext('2d').drawImage(video, 0, 0, 426, 240);
  }
  document.getElementById('capture').addEventListener('click', function(){
    thumbnail();	
    addImg();
    
    
  });

  // document.getElementById('video_thumbnail_upload').addEventListener('click', function(){
  //   var canvas = document.getElementById('canvas');
  //   var dataUrl = canvas.toDataURL("image/jpeg");
  //   var dataImg = document.createElement('img');
  //   dataImg.src = dataUrl;
  // });

  function addImg() {
    var canvas = document.getElementById('canvas');

    canvas.toBlob(function(blob) {
      var img = document.getElementById('video_image'),
          url = URL.createObjectURL(blob),
					div = document.getElementsByClassName('middle_content')[0];
			
			var base64 = "";
			blobReader.readAsDataURL(blob);
			blobReader.onloadend = function() {
				var result = blobReader.result;
				base64 = result.substr(result.indexOf(',')+1);
				var newImg = document.createElement('img');
				newImg.src = "data:image/jpeg;base64," + base64;
				newImg.id = "base64_image";
				document.body.appendChild(newImg);
				console.log(base64);

				var full_base64 =  "data:image/jpeg;base64," + base64;
        document.querySelector('#video_path_field').value = full_base64;

				// $.ajax({
				// 	data: 'base64=' + full_base64,
				// 	type: 'POST',
				// 	url: "/videos/<%=@video.id%>/upload"
				// });
			}

			

      img.onload = function() {
        // no longer need to read the blob so it's revoked
        URL.revokeObjectURL(url);
      };

      img.src = url;
    });
  }
</script>